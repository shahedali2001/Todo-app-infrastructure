trigger: 
  branches:
    include:
      - main

pool: todo-app-infra  # Self-hosted agent for Terraform tasks
parameters:
- name: MaxConcurrency
  type: number
  default: 1
parameters:
  - name: Environment
    type: string
    default: dev
    values:
      - dev
      - preprod
      - prod

stages:

# ---------------- Terraform Init ----------------
- stage: TerraformInit
  displayName: Terraform Init
  jobs:
    - job: TerraformInit
      displayName: Terraform Init
      steps:
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            backendServiceArm: 'shahedado'
            backendAzureRmResourceGroupName: 'libo-rg'
            backendAzureRmStorageAccountName: 'libo4520'
            backendAzureRmContainerName: 'tfscontainer'
            backendAzureRmKey: 'preprod.terraform.tfstate'

# ---------------- Terraform Validate & Plan ----------------
- stage: TerraformValidate
  displayName: Terraform Validate & Plan
  dependsOn: TerraformInit
  jobs:
    - job: TerraformValidate
      displayName: Terraform Validate & Plan
      steps:
        # Terraform init again on this stage/agent
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            backendServiceArm: 'shahedado'
            backendAzureRmResourceGroupName: 'libo-rg'
            backendAzureRmStorageAccountName: 'libo4520'
            backendAzureRmContainerName: 'tfscontainer'
            backendAzureRmKey: 'preprod.terraform.tfstate'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            environmentServiceNameAzureRM: 'shahedado'

# ---------------- Checkov Secret/Infrastructure Scan ----------------
- stage: CheckovScan
  displayName: Checkov Scan
  dependsOn: TerraformValidate
  pool: todo-app-infra  # Use self-hosted agent
  jobs:
    - job: CheckovScan
      displayName: Checkov Scan
      steps:
        - checkout: self

        # Ensure Python is available on agent
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.x'
            addToPath: true

        # Install Checkov
        - powershell: |
            python -m pip install --upgrade pip
            pip install checkov
          displayName: Install Checkov

        # Run Checkov scan
        - powershell: |
            checkov -d $(System.DefaultWorkingDirectory)/dev --quiet
          displayName: Run Checkov Scan

# ---------------- Terraform Lint ----------------
- stage: TerraformScan
  dependsOn: CheckovScan
  displayName: Terraform Scan
  jobs:
    - job: TerraformScan
      displayName: TFLint Scan
      steps:
        - powershell: |
              $env:PATH = "$(Agent.ToolsDirectory)\tflint;$env:PATH"
              tflint --version

        - powershell: |
              cd "$(System.DefaultWorkingDirectory)/dev"
              tflint --init
              tflint
              Write-Host "TFLint scan completed (warnings/errors ignored)."
              exit 0
          displayName: TFLint Scan
# ---------------- Manual Approval ----------------
- stage: ManualValidation
  displayName: Manual Validation
  dependsOn: TerraformScan
  jobs:
    - job: WaitForApproval
      displayName: Manual Approval
      pool: server
      steps:
        - task: ManualValidation@1
          inputs:
            instructions: "Please review and approve before continuing."

# ---------------- Terraform Apply ----------------
- stage: TerraformApply
  displayName: Terraform Apply
  dependsOn: ManualValidation
  jobs:
    - job: TerraformApply
      displayName: Terraform Apply
      steps:
        # Terraform init again before apply
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            backendServiceArm: 'shahedado'
            backendAzureRmResourceGroupName: 'libo-rg'
            backendAzureRmStorageAccountName: 'libo4520'
            backendAzureRmContainerName: 'tfscontainer'
            backendAzureRmKey: 'preprod.terraform.tfstate'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            environmentServiceNameAzureRM: 'shahedado'
            additionalArgs: '-auto-approve'
