trigger: none  # or 'trigger: - main' if you want automatic runs

pool:
  name: shahedali-pipeline  # ✅ Ensure this pool exists and is authorized

stages:
  # ----------------------------
  # Stage 1: Terraform Setup
  # ----------------------------
  - stage: terraformInstall
    displayName: Terraform Installation
    jobs:
      - job: TerraformSetup
        displayName: Install and Run Terraform Commands
        pool:
          name: shahedali-pipeline
        steps:
          # ✅ Install Terraform
          - task: JasonBJohnson.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@2
            displayName: "Install Terraform"
            inputs:
              terraformVersion: 'latest'

          # ✅ Terraform Init
          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Todo_app_infra/dev'
              backendServiceArm: 'todo-app-infra'  # ✅ Azure DevOps Service Connection name
              backendAzureRmResourceGroupName: 'shahed-dev-01'
              backendAzureRmStorageAccountName: 'shahed490'
              backendAzureRmContainerName: 'shahed'
              backendAzureRmKey: 'shahed.terraform.tfstate'

          # ✅ Terraform Validate
          - task: TerraformTaskV4@4
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Todo_app_infra/dev'

          # ✅ Terraform Plan
          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Todo_app_infra/dev'
              environmentServiceNameAzureRM: 'todo-app-infra'

  # ----------------------------
  # Stage 2: Security Scan
  # ----------------------------
  - stage: securityTools
    displayName: Security Tool Scanning
    dependsOn: terraformInstall
    jobs:
      - job: SecurityScan
        displayName: Run tfsec (local scan)
        pool:
          name: shahedali-pipeline
        steps:
          - powershell: |
              Write-Host "Running tfsec scan..."
              $tfsecPath = "D:\software\security_tools\tfsec.exe"

              if (-not (Test-Path $tfsecPath)) {
                  Write-Host "⚠️ tfsec not found at path: $tfsecPath"
                  exit 0
              }

              & $tfsecPath "$(System.DefaultWorkingDirectory)\Todo_app_infra\dev\" --no-update-check --soft-fail
            displayName: "Run tfsec from local path"

  # ----------------------------
  # Stage 3: Deployment
  # ----------------------------
  - stage: deployment
    displayName: Terraform Apply
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    dependsOn: securityTools
    jobs:
      - job: ManualValidation
        displayName: Manual Validation
        pool: server
        steps:
          - task: ManualValidation@1
            inputs:
              notifyUsers: 'shahedali2001@gmail.com'
              instructions: 'Approve deployment to production.'

      - job: TerraformApply
        displayName: Terraform Apply
        dependsOn: ManualValidation
        pool:
          name: shahedali-pipeline
        steps:
          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Todo_app_infra/dev'
              backendServiceArm: 'todo-app-infra'
              backendAzureRmResourceGroupName: 'shahed-dev-01'
              backendAzureRmStorageAccountName: 'shahed490'
              backendAzureRmContainerName: 'shahed'
              backendAzureRmKey: 'shahed.terraform.tfstate'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Todo_app_infra/dev'
              environmentServiceNameAzureRM: 'todo-app-infra'
