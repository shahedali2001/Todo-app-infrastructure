trigger:
  branches:
    include:
      - feature/101
    exclude:
      - main

pool:
  name: 'todo-app-infra'

parameters:
  - name: Environment
    type: string
    default: dev
    values:
      - dev
      - qa
      - prod

stages:
  # ----------------------------
  # Stage 1: Terraform Installation
  # ----------------------------
  - stage: TerraformInstallation
    displayName: "Terraform Installation"
    jobs:
      - job: TerraformInstall
        displayName: "Install Terraform"
        steps:
          - task: TerraformInstaller@2
            inputs:
              terraformVersion: '1.10.5'

  # ----------------------------
  # Stage 2: Terraform Init
  # ----------------------------
  - stage: TerraformInit
    displayName: "Terraform Init"
    dependsOn: TerraformInstallation
    condition: succeeded()
    jobs:
      - job: TerraformInit
        displayName: "Initialize Terraform Backend"
        steps:
          # Ensure Terraform is installed (safe redundancy)
          - task: TerraformInstaller@2
            inputs:
              terraformVersion: '1.10.5'

          # Run Terraform Init
          - task: TerraformCLI@2
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Todo-app-infrastructure/${{ parameters.Environment }}/'
              backendType: 'azurerm'
              backendServiceArm: 'todo-app-infra'
              backendAzureRmTenantId: '308cf1f9-a8ab-4d6c-8f2d-e645787abd05'
              backendAzureRmSubscriptionId: '2c6da294-c904-4801-bffd-cd7f0b236e3d'
              backendAzureRmResourceGroupName: 'shahed-dev-01'
              backendAzureRmStorageAccountName: 'shahed490'
              backendAzureRmContainerName: 'shahed'
              backendAzureRmKey: '${{ parameters.Environment }}.terraform.tfstate'
              allowTelemetryCollection: false
