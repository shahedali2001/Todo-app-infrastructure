trigger:
  branches:
    include:
      - main

parameters:
  - name: Environment
    type: string
    default: dev
    values:
      - dev
      - qa
      - prod

pool:
  name: 'todo-app-infra'

stages:
  - stage: TerraformInit
    displayName: "Terraform Init, Validate, Plan"
    jobs:
      - job: TerraformInit
        displayName: "Terraform Init, Validate, Plan"
        steps:
          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
              backendServiceArm: 'shahedsvc'
              backendAzureRmResourceGroupName: 'shahed-rg'
              backendAzureRmStorageAccountName: 'shahedstg881'
              backendAzureRmContainerName: 'tfscontainer'
              backendAzureRmKey: 'dev.terraform.tfstate'
              ensureBackend: true

          - task: TerraformTask@5
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/dev'

          - task: TerraformTask@5
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
              environmentServiceNameAzureRM: 'shahedsvc'

  - stage: Scanning_of_Code
    displayName: "Terraform Scan Code"
    dependsOn: TerraformInit
    jobs:
      - job: scanningCode
        displayName: "Scanning Code"
        steps:
          # Step 1: Download latest TFLint for Windows dynamically
          - powershell: |
              $tflintRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/terraform-linters/tflint/releases/latest"
              $url = $tflintRelease.assets | Where-Object { $_.name -like "*windows_amd64.zip" } | Select-Object -ExpandProperty browser_download_url
              Write-Host "Downloading TFLint from $url"
              Invoke-WebRequest -Uri $url -OutFile "tflint.zip"
              Expand-Archive tflint.zip -DestinationPath "$(Agent.ToolsDirectory)\tflint" -Force
            displayName: "Download and extract TFLint"

          # Step 2: Add TFLint to PATH
          - powershell: |
              $env:PATH = "$(Agent.ToolsDirectory)\tflint;$env:PATH"
              tflint --version
            displayName: "Verify TFLint installation"

          # Step 3: Run TFLint scan (warnings won't fail pipeline)
          - powershell: |
              cd "$(System.DefaultWorkingDirectory)/dev"
              tflint --init
              tflint
              if ($LASTEXITCODE -eq 1) {
                  Write-Host "TFLint found issues, but allowing pipeline to continue."
                  exit 0
              }
            displayName: "Run TFLint Scan"

  - stage: ManualValidation
    displayName: "Manual Validation"
    dependsOn: Scanning_of_Code
    jobs:
      - job: WaitForApproval
        displayName: "Manual Validation"
       
  - stage: TerraformApply
    displayName: "Terraform Apply"
    dependsOn: ManualValidation
    jobs:
      - job: TerraformApply
        displayName: "Terraform Apply"
        steps:
          - task: TerraformTask@5
            displayName: 'Terraform Init Before Apply'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
              backendServiceArm: 'shahedsvc'
              backendAzureRmResourceGroupName: 'shahed-rg'
              backendAzureRmStorageAccountName: 'shahedstg881'
              backendAzureRmContainerName: 'tfscontainer'
              backendAzureRmKey: 'dev.terraform.tfstate'
              ensureBackend: true

          - task: TerraformTask@5
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
              environmentServiceNameAzureRM: 'shahedsvc'
              autoApprove: true
