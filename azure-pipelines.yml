trigger:
  branches:
    include:
      - main
    
      
      

pool:
  name: 'todo-app-infra'

parameters:
  - name: Environment
    type: string
    default: dev
    values:
      - dev
      - qa
      - prod

stages:
  # Stage 1: Terraform Init
  - stage: TerraformInit
    displayName: "Terraform Init,validate,plan"
    jobs:
      - job: TerraformInit
        displayName: "Terraform Init"
        steps:
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            backendServiceArm: 'shahedsvc'
            backendAzureRmResourceGroupName: 'shahed-dev-01'
            backendAzureRmStorageAccountName: 'shahedstg779'
            backendAzureRmContainerName: 'tfscontainer'
            backendAzureRmKey: 'dev.terraform.tfstate'
     
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            environmentServiceNameAzureRM: 'shahedsvc'
    # Stage 2: Terraform Apply        
  - stage: TerraformApply
    displayName: "Terraform apply"
    jobs:
      - job: TerraformApply
        displayName: "Terraform apply"
        steps:
        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            environmentServiceNameAzureRM: 'shahedsvc'
        


